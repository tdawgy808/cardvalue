<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trading Card Valuation — Advanced OCR v1.2</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<style>html{background:#0b1020}.card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)}.sel{position:absolute;border:2px dashed #a5b4fc;background:rgba(165,180,252,.1)}canvas{max-width:100%}</style>
</head>
<body class="text-slate-100 p-6">
<h1 class="text-2xl mb-4">Trading Card Valuation — Advanced OCR v1.2</h1>
<div class="grid md:grid-cols-2 gap-6">
<div class="card p-4 rounded-xl">
<input type="file" id="fileInput" accept="image/*" class="mb-3"/>
<div class="flex gap-2 mb-3">
<button id="btnOCR" class="bg-indigo-600 rounded px-3 py-1">Run OCR</button>
<button id="btnAlt" class="bg-slate-700 rounded px-3 py-1">Alt OCR</button>
<button id="btnRotate" class="bg-slate-700 rounded px-3 py-1">Rotate</button>
<button id="btnFlipH" class="bg-slate-700 rounded px-3 py-1">Flip H</button>
</div>
<div id="ocrStatus" class="text-xs mb-2"></div>
<canvas id="canvas"></canvas>
<div id="selBox" class="sel hidden"></div>
<div class="grid grid-cols-4 gap-2 mt-2 text-xs">
<button data-roi="name" class="roi bg-emerald-700 px-2 py-1 rounded">Select Name</button>
<button data-roi="set" class="roi bg-emerald-700 px-2 py-1 rounded">Select Set</button>
<button data-roi="number" class="roi bg-emerald-700 px-2 py-1 rounded">Select #</button>
<button data-roi="year" class="roi bg-emerald-700 px-2 py-1 rounded">Select Year</button>
</div>
</div>
<div class="card p-4 rounded-xl">
<div class="grid gap-2">
<input id="field_name" placeholder="Player / Character" class="bg-white/10 p-2 rounded"/>
<input id="field_set" placeholder="Set / Expansion" class="bg-white/10 p-2 rounded"/>
<input id="field_number" placeholder="Card #" class="bg-white/10 p-2 rounded"/>
<input id="field_year" placeholder="Year" class="bg-white/10 p-2 rounded"/>
</div>
</div>
</div>
<script>
const c=$('#canvas'),ctx=c.getContext('2d');let img,alt=false,roiMode=null,selBox=$('#selBox');
function $(id){return document.querySelector(id)}
$('#fileInput').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{img=new Image();img.onload=()=>{draw(img)};img.src=r.result;};r.readAsDataURL(f);});
function draw(i){c.width=i.width;c.height=i.height;ctx.drawImage(i,0,0);} 
function preprocess(thr){const temp=document.createElement('canvas');temp.width=c.width;temp.height=c.height;const tctx=temp.getContext('2d');tctx.drawImage(c,0,0);const d=tctx.getImageData(0,0,temp.width,temp.height);const a=d.data;for(let i=0;i<a.length;i+=4){const g=(a[i]*.3+a[i+1]*.59+a[i+2]*.11);let bw=g>(thr||160)?255:0;if(alt)bw=255-bw;a[i]=a[i+1]=a[i+2]=bw;a[i+3]=255;}tctx.putImageData(d,0,0);return temp;}
async function ocrCanvas(cnv,label){const {data}=await Tesseract.recognize(cnv.toDataURL('image/png'),'eng',{logger:m=>{$('#ocrStatus').textContent=(label||'')+': '+(m.status||'')+' '+Math.round((m.progress||0)*100)+'%';}});return(data.text||'').trim();}
$('#btnOCR').onclick=async()=>{if(!img)return;$('#ocrStatus').textContent='Running OCR...';const pre=preprocess(160);const text=await ocrCanvas(pre,'main');fillFields(text);$('#ocrStatus').textContent='Done.';}
function fillFields(t){const y=t.match(/(19\d{2}|20\d{2})/);if(y)$('#field_year').value=y[1];const n=t.match(/(?:#|No\.?|Nº)\s*(\d+)/i);if(n)$('#field_number').value=n[1];const lines=t.split(/\n/).filter(Boolean);$('#field_name').value=lines[0]||'';$('#field_set').value=lines.find(l=>/(Topps|Panini|Pok[eé]mon|Magic|Prizm|Bowman)/i)||'';}
$('#btnAlt').onclick=()=>{alt=!alt;$('#btnAlt').classList.toggle('bg-indigo-600');};
$('#btnRotate').onclick=()=>{ctx.translate(c.width/2,c.height/2);ctx.rotate(Math.PI/2);ctx.drawImage(c,-c.width/2,-c.height/2);ctx.setTransform(1,0,0,1,0,0);};
$('#btnFlipH').onclick=()=>{ctx.translate(c.width,0);ctx.scale(-1,1);ctx.drawImage(c,0,0);ctx.setTransform(1,0,0,1,0,0);};
document.querySelectorAll('.roi').forEach(b=>b.onclick=()=>{roiMode=b.dataset.roi;$('#ocrStatus').textContent='Select area for '+roiMode;});
let startX=0,startY=0,sel=false;c.onmousedown=e=>{if(!roiMode)return;sel=true;const r=c.getBoundingClientRect();startX=e.clientX-r.left;startY=e.clientY-r.top;selBox.classList.remove('hidden');selBox.style.left=startX+'px';selBox.style.top=startY+'px';selBox.style.width='0px';selBox.style.height='0px';}
c.onmousemove=e=>{if(!sel)return;const r=c.getBoundingClientRect();const x=e.clientX-r.left,y=e.clientY-r.top;selBox.style.width=Math.abs(x-startX)+'px';selBox.style.height=Math.abs(y-startY)+'px';}
window.onmouseup=async e=>{if(!sel)return;sel=false;const r=c.getBoundingClientRect();const endX=e.clientX-r.left,endY=e.clientY-r.top;selBox.classList.add('hidden');const x=Math.min(startX,endX),y=Math.min(startY,endY),w=Math.abs(endX-startX),h=Math.abs(endY-startY);if(w<5||h<5)return;const region=document.createElement('canvas');region.width=w;region.height=h;region.getContext('2d').drawImage(c,x,y,w,h,0,0,w,h);const pre=preprocess(160);const txt=await ocrCanvas(region,roiMode);const val=txt.trim();if(roiMode==='name')$('#field_name').value=val;if(roiMode==='set')$('#field_set').value=val;if(roiMode==='number')$('#field_number').value=val;if(roiMode==='year')$('#field_year').value=val;roiMode=null;};
</script>
</body>
</html>
